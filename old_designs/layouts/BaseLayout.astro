---
import './styles/signal.css';
import { getAllTranslations } from '../../src/i18n/index';

interface Props {
  title?: string;
  description?: string;
}

const {
  title = "The Slow Road Back | Riding4GBS",
  description = "A Pyrenean cycling challenge to raise awareness and funds for Guillain-Barr√© Syndrome. Follow Martin's journey across the mountains.",
} = Astro.props;

const i18nTranslations = getAllTranslations();
---
<!doctype html>
<html lang="en" class="variant-signal">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://riding4gbs.com" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <script>
      (function() {
        var STORAGE_KEY = 'riding4gbs-theme';
        var root = document.documentElement;
        var media = window.matchMedia('(prefers-color-scheme: dark)');

        function systemTheme() {
          return media.matches ? 'dark' : 'light';
        }

        function normalize(mode) {
          return mode === 'dark' || mode === 'light' ? mode : 'system';
        }

        function resolve(mode) {
          return mode === 'system' ? systemTheme() : mode;
        }

        function apply(mode) {
          var resolved = resolve(mode);
          root.dataset.themeMode = mode;
          root.dataset.theme = resolved;
          root.classList.toggle('theme-dark', resolved === 'dark');
          root.classList.toggle('theme-light', resolved === 'light');
          root.classList.toggle('theme-system', mode === 'system');
        }

        var initialMode = normalize(localStorage.getItem(STORAGE_KEY) || 'system');
        apply(initialMode);

        function syncSystem() {
          if ((localStorage.getItem(STORAGE_KEY) || 'system') === 'system') {
            apply('system');
            document.dispatchEvent(new CustomEvent('theme:changed', {
              detail: { mode: 'system', theme: resolve('system') }
            }));
          }
        }

        media.addEventListener('change', syncSystem);

        window.__setTheme = function(mode) {
          var next = normalize(mode);
          localStorage.setItem(STORAGE_KEY, next);
          apply(next);
          document.dispatchEvent(new CustomEvent('theme:changed', {
            detail: { mode: next, theme: resolve(next) }
          }));
        };

        window.__getThemeMode = function() {
          return normalize(localStorage.getItem(STORAGE_KEY) || 'system');
        };

        window.__getResolvedTheme = function() {
          return resolve(normalize(localStorage.getItem(STORAGE_KEY) || 'system'));
        };
      })();
    </script>
    <title>{title}</title>
    <script define:vars={{ i18nTranslations }}>
      window.__i18n_translations = i18nTranslations;
      // Detect language early to prevent flash of wrong language
      (function() {
        var lang = localStorage.getItem('riding4gbs-lang') || 'en';
        document.documentElement.lang = lang;
        if (lang !== 'en') {
          document.documentElement.classList.add('i18n-loading');
        }
      })();
    </script>
    <style>
      /* Hide translatable content until i18n is applied to prevent flash */
      .i18n-loading [data-i18n],
      .i18n-loading [data-i18n-html],
      .i18n-loading [data-i18n-placeholder] {
        visibility: hidden;
      }
    </style>
  </head>
  <body class="min-h-screen overflow-x-hidden">
    <slot />
    <script>
      import '../src/i18n/client.ts';
      import { inject } from '@vercel/analytics';
      inject();
    </script>
  </body>
</html>
