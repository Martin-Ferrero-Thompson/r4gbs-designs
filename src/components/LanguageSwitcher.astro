---
interface Props {
  variant?: '1' | '4';
}

const { variant = '1' } = Astro.props;
const flags: Record<string, string> = {
  en: '<svg class="h-3.5 w-5 shrink-0 rounded-sm overflow-hidden" viewBox="0 0 60 40"><rect width="60" height="40" fill="#012169" rx="2"/><path d="M0 0L60 40M60 0L0 40" stroke="#fff" stroke-width="8"/><path d="M0 0L60 40M60 0L0 40" stroke="#C8102E" stroke-width="4"/><path d="M30 0v40M0 20h60" stroke="#fff" stroke-width="12"/><path d="M30 0v40M0 20h60" stroke="#C8102E" stroke-width="6"/></svg>',
  es: '<svg class="h-3.5 w-5 shrink-0 rounded-sm overflow-hidden" viewBox="0 0 60 40"><rect width="60" height="40" fill="#AA151B" rx="2"/><rect y="10" width="60" height="20" fill="#F1BF00"/></svg>',
  eu: '<svg class="h-3.5 w-5 shrink-0 rounded-sm overflow-hidden" viewBox="0 0 60 40"><rect width="60" height="40" fill="#D52B1E" rx="2"/><path d="M0 0L60 40M60 0L0 40" stroke="#39884C" stroke-width="8"/><path d="M30 0v40M0 20h60" stroke="#fff" stroke-width="6"/></svg>',
};

const languages = [
  { code: 'en', label: 'English', flag: flags.en },
  { code: 'es', label: 'Espa√±ol', flag: flags.es },
  { code: 'eu', label: 'Euskara', flag: flags.eu },
];

const variantStyles: Record<string, { trigger: string; menu: string; option: string; selected: string }> = {
  '1': {
    trigger: 'text-stone-400 hover:text-stone-200 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-stone-600',
    menu: 'bg-stone-950/95 border border-stone-800 shadow-lg shadow-black/30 text-stone-200',
    option: 'text-stone-300 hover:text-stone-100',
    selected: 'text-amber-400',
  },
  '4': {
    trigger: 'text-[#7d7d7d] hover:text-[#c5c5c5] focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-[#39FF14]/50',
    menu: 'bg-[#050505]/95 border border-[#39FF14]/15 shadow-lg shadow-black/40 text-[#e5e5e5]',
    option: 'text-[#b3b3b3] hover:text-white',
    selected: 'text-[#39FF14]',
  },
};

const styles = variantStyles[variant] ?? variantStyles['1'];
---
<div class="relative inline-block" data-lang-root data-selected-class={styles.selected}>
  <button
    type="button"
    class={`inline-flex items-center gap-1.5 text-sm font-medium transition-colors duration-150 ${styles.trigger}`}
    data-lang-trigger
    aria-haspopup="listbox"
    aria-expanded="false"
  >
    <span data-lang-flag aria-hidden="true" set:html={flags.en}></span>
    <span data-lang-current translate="no">EN</span>
    <svg aria-hidden="true" class="h-3 w-3" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M3 6l5 5 5-5" stroke-linecap="round" stroke-linejoin="round" />
    </svg>
  </button>

  <div
    class={`absolute right-0 mt-2 min-w-[140px] rounded-lg p-2 opacity-0 scale-95 pointer-events-none transition duration-150 ease-out ${styles.menu}`}
    data-lang-menu
    role="listbox"
    aria-label="Select language"
  >
    {languages.map((lang) => (
      <button
        type="button"
        role="option"
        data-lang-option={lang.code}
        class={`flex w-full items-center gap-2.5 rounded-md px-3 py-2 text-sm transition-colors duration-150 ${styles.option}`}
      >
        <span aria-hidden="true" class="flex-shrink-0" set:html={lang.flag}></span>
        <span class="flex-1" translate="no">{lang.label}</span>
        <svg aria-hidden="true" data-checkmark class="h-4 w-4 flex-shrink-0 opacity-0" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M5 10.5l3.5 3.5L15 6" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </button>
    ))}
  </div>
</div>

<script>
  const LANG_STORAGE_KEY = 'riding4gbs-lang';

  function getCurrentLang() {
    return localStorage.getItem(LANG_STORAGE_KEY) || 'en';
  }

  function setCurrentLang(value) {
    if (window.__setLang) window.__setLang(value);
  }

  const flagSVGs = {
    en: '<svg class="h-3.5 w-5 shrink-0 rounded-sm overflow-hidden" viewBox="0 0 60 40"><rect width="60" height="40" fill="#012169" rx="2"/><path d="M0 0L60 40M60 0L0 40" stroke="#fff" stroke-width="8"/><path d="M0 0L60 40M60 0L0 40" stroke="#C8102E" stroke-width="4"/><path d="M30 0v40M0 20h60" stroke="#fff" stroke-width="12"/><path d="M30 0v40M0 20h60" stroke="#C8102E" stroke-width="6"/></svg>',
    es: '<svg class="h-3.5 w-5 shrink-0 rounded-sm overflow-hidden" viewBox="0 0 60 40"><rect width="60" height="40" fill="#AA151B" rx="2"/><rect y="10" width="60" height="20" fill="#F1BF00"/></svg>',
    eu: '<svg class="h-3.5 w-5 shrink-0 rounded-sm overflow-hidden" viewBox="0 0 60 40"><rect width="60" height="40" fill="#D52B1E" rx="2"/><path d="M0 0L60 40M60 0L0 40" stroke="#39884C" stroke-width="8"/><path d="M30 0v40M0 20h60" stroke="#fff" stroke-width="6"/></svg>',
  };

  function updateLangUI(root) {
    const current = getCurrentLang();
    const currentEl = root.querySelector('[data-lang-current]');
    if (currentEl) currentEl.textContent = current.toUpperCase();

    const flagEl = root.querySelector('[data-lang-flag]');
    if (flagEl && current in flagSVGs) flagEl.innerHTML = flagSVGs[current as keyof typeof flagSVGs];

    root.querySelectorAll('[data-lang-option]').forEach((btn) => {
      const code = btn.getAttribute('data-lang-option');
      const isActive = code === current;
      const icon = btn.querySelector('[data-checkmark]');

      const selectedClasses = (root.dataset.selectedClass || '').split(/\s+/).filter(Boolean);

      if (isActive) {
        btn.classList.add(...selectedClasses);
        btn.classList.remove('opacity-80');
        btn.setAttribute('aria-selected', 'true');
      } else {
        btn.classList.remove(...selectedClasses);
        btn.classList.add('opacity-80');
        btn.setAttribute('aria-selected', 'false');
      }
      if (icon) icon.style.opacity = isActive ? '1' : '0';
    });
  }

  function closeMenu(root) {
    const menu = root.querySelector('[data-lang-menu]');
    const trigger = root.querySelector('[data-lang-trigger]');
    if (!menu || !trigger) return;
    menu.classList.add('pointer-events-none', 'opacity-0', 'scale-95');
    trigger.setAttribute('aria-expanded', 'false');
  }

  function openMenu(root) {
    const menu = root.querySelector('[data-lang-menu]');
    const trigger = root.querySelector('[data-lang-trigger]');
    if (!menu || !trigger) return;
    document.dispatchEvent(new CustomEvent('dropdown:opened', { detail: { source: 'lang' } }));
    menu.classList.remove('pointer-events-none', 'opacity-0', 'scale-95');
    trigger.setAttribute('aria-expanded', 'true');
  }

  function setupLanguageDropdown(root) {
    const trigger = root.querySelector('[data-lang-trigger]');
    const menu = root.querySelector('[data-lang-menu]');
    if (!trigger || !menu) return;

    updateLangUI(root);

    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = trigger.getAttribute('aria-expanded') === 'true';
      if (isOpen) {
        closeMenu(root);
      } else {
        openMenu(root);
      }
    });

    menu.querySelectorAll('[data-lang-option]').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const code = btn.getAttribute('data-lang-option');
        if (code) {
          setCurrentLang(code);
          updateLangUI(root);
        }
        closeMenu(root);
      });
    });

    document.addEventListener('click', (event) => {
      if (!root.contains(event.target)) closeMenu(root);
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') closeMenu(root);
    });

    document.addEventListener('dropdown:opened', (event) => {
      if (event.detail?.source !== 'lang') closeMenu(root);
    });
  }

  document.querySelectorAll('[data-lang-root]').forEach((root) => {
    setupLanguageDropdown(root);
  });

  document.addEventListener('lang:changed', () => {
    document.querySelectorAll('[data-lang-root]').forEach((root) => updateLangUI(root));
  });
</script>

<style>
  [data-lang-menu] {
    backdrop-filter: blur(8px);
  }

  [data-lang-menu].opacity-0 {
    visibility: hidden;
  }
</style>
